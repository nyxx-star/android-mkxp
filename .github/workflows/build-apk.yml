name: Build android-mkxp

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
        
    - name: Setup JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Setup Android SDK manually
      run: |
        # Usa SDK já instalado no runner
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        echo "ANDROID_HOME: $ANDROID_HOME"
        
        # Aceita licenças
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses || true
        
        # Instala NDK se não existir
        if [ ! -d "$ANDROID_SDK_ROOT/ndk/25.2.9519653" ]; then
          $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "ndk;25.2.9519653"
        fi
        
    - name: Configure build
      run: |
        # Cria local.properties
        cat > local.properties << EOF
sdk.dir=$ANDROID_SDK_ROOT
ndk.dir=$ANDROID_SDK_ROOT/ndk/25.2.9519653
EOF
        
        echo "=== local.properties ==="
        cat local.properties
        
    - name: Build APK
      run: |
        chmod +x gradlew
        
        # Limpa e build
        ./gradlew clean
        ./gradlew assembleDebug
        
    - name: Check APK location
      run: |
        echo "=== Verificando APK ==="
        
        # Procura em vários locais possíveis
        APK_PATHS=(
          "app/build/outputs/apk/debug/*.apk"
          "app/build/outputs/apk/*.apk"
          "build/outputs/apk/debug/*.apk"
          "*.apk"
        )
        
        for path in "${APK_PATHS[@]}"; do
          if ls $path 1> /dev/null 2>&1; then
            echo "✅ APK encontrado em: $path"
            echo "APK_PATH=$(realpath $path)" >> $GITHUB_ENV
            ls -lh $path
            break
          fi
        done
        
        if [ -z "$APK_PATH" ]; then
          echo "❌ Nenhum APK encontrado"
          echo "=== Listando diretório build ==="
          find app/build -type f -name "*.apk" 2>/dev/null || true
        fi
        
    - name: Upload APK
      if: env.APK_PATH != ''
      uses: actions/upload-artifact@v4
      with:
        name: android-mkxp-apk
        path: ${{ env.APK_PATH }}
        
    - name: Upload Build Directory (se falhar)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-failed-logs
        path: |
          app/build/
          build/
        retention-days: 7
