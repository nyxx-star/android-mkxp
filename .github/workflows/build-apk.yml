name: Build android-mkxp APK

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:  # Permite trigger manual

jobs:
  build-debug:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        path: android-mkxp
        
    - name: Setup Java 17 (for Android SDK)
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        build-tools-version: "33.0.2"
        ndk-version: "25.2.9519653"
        cmdline-tools-version: "latest"
        extra-license-ids: |
          android-sdk-license
          android-sdk-preview-license
          
    - name: Setup Java 11 (for project Gradle)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
        
    - name: Create local.properties
      working-directory: ./android-mkxp
      run: |
        echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
        echo "ndk.dir=$ANDROID_SDK_ROOT/ndk/25.2.9519653" >> local.properties
        
    - name: Make gradlew executable
      working-directory: ./android-mkxp
      run: chmod +x gradlew
        
    - name: Build Debug APK
      working-directory: ./android-mkxp
      run: |
        ./gradlew assembleDebug \
          --no-daemon \
          --stacktrace \
          --info \
          -Dorg.gradle.jvmargs="-Xmx4g"
        
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: android-mkxp-debug
        path: android-mkxp/app/build/outputs/apk/debug/*.apk
        retention-days: 30
        
  build-release:
    needs: build-debug
    runs-on: ubuntu-22.04
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        path: android-mkxp
        
    - name: Setup Java 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
        
    - name: Setup Android
      uses: android-actions/setup-android@v3
      
    - name: Create local.properties
      working-directory: ./android-mkxp
      run: |
        echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
        echo "ndk.dir=$ANDROID_SDK_ROOT/ndk/25.2.9519653" >> local.properties
        
    - name: Build Release APK
      working-directory: ./android-mkxp
      run: |
        ./gradlew assembleRelease \
          --no-daemon \
          --stacktrace \
          -Dorg.gradle.jvmargs="-Xmx4g"
        
    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: android-mkxp-release
        path: android-mkxp/app/build/outputs/apk/release/*.apk
        retention-days: 30
