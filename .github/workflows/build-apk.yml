name: Build android-mkxp APK

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Show directory structure
      run: |
        echo "=== ESTRUTURA ATUAL ==="
        pwd
        ls -la
        echo ""
        echo "=== EXISTE PASTA APP? ==="
        if [ -d "app" ]; then
          echo "✅ SIM, pasta 'app' existe!"
          ls -la app/
        else
          echo "❌ NÃO, pasta 'app' NÃO existe!"
          echo "=== Procurando por app ==="
          find . -type d -name "app" | head -5
        fi
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        build-tools-version: "33.0.2"
        ndk-version: "25.2.9519653"
        
    - name: Create local.properties
      run: |
        echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
        echo "ndk.dir=$ANDROID_SDK_ROOT/ndk/25.2.9519653" >> local.properties
        
    - name: Make gradlew executable
      run: chmod +x gradlew
        
    - name: Build APK
      run: |
        echo "=== Iniciando build ==="
        ./gradlew clean assembleDebug --stacktrace
        
    - name: Find and list APKs
      run: |
        echo "=== Buscando APKs ==="
        
        # Primeiro, verifica o local padrão
        DEFAULT_PATH="app/build/outputs/apk/debug"
        
        if [ -d "$DEFAULT_PATH" ]; then
          echo "✅ Pasta encontrada: $DEFAULT_PATH"
          ls -la "$DEFAULT_PATH/"
          
          APK_FILES=$(find "$DEFAULT_PATH" -name "*.apk" -type f 2>/dev/null)
          if [ -n "$APK_FILES" ]; then
            echo "✅ APK(s) encontrado(s):"
            echo "$APK_FILES"
            # Pega o primeiro APK encontrado
            FIRST_APK=$(echo "$APK_FILES" | head -1)
            echo "APK_PATH=$FIRST_APK" >> $GITHUB_ENV
          else
            echo "❌ Nenhum APK na pasta padrão"
          fi
        else
          echo "❌ Pasta padrão não existe: $DEFAULT_PATH"
          echo "=== Procurando em todo o projeto ==="
          find . -name "*.apk" -type f 2>/dev/null | head -10 || echo "Nenhum APK encontrado"
        fi
        
    - name: Upload APK (if found)
      if: env.APK_PATH != ''
      uses: actions/upload-artifact@v4
      with:
        name: android-mkxp-apk
        path: ${{ env.APK_PATH }}
        
    - name: Upload build directory for debugging
      if: failure() || env.APK_PATH == ''
      uses: actions/upload-artifact@v4
      with:
        name: debug-files
        path: |
          app/build/
          build/
        retention-days: 7
